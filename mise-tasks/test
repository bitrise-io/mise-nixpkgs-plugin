#!/usr/bin/env bash
#MISE description="Run backend plugin tests - test plugin linking and basic functionality"
set -euo pipefail

run_test() {
    local test_name="$1"
    local cmd="$2"

    echo "Testing ${test_name}..."
    if output=$(eval "$cmd" 2>&1); then
        echo "✓ ${test_name} works"
        return 0
    else
        echo "✗ ${test_name} failed"
        echo "Command: $cmd"
        echo "Output:"
        echo "$output"
        return 1
    fi
}

mise plugin link --force nixpkgs .
mise cache clear

echo "Testing plugin linking and basic functionality..."

TEST_TOOL="ruby"

run_test "version listing for ${TEST_TOOL}" \
    "mise ls-remote nixpkgs:${TEST_TOOL}" || exit 1

run_test "installation of ${TEST_TOOL}" \
    "mise install nixpkgs:${TEST_TOOL}@latest" || exit 1

run_test "tool execution for ${TEST_TOOL}" \
    "mise exec nixpkgs:${TEST_TOOL}@latest -- ${TEST_TOOL} --version" || exit 1

echo "✓ Basic plugin structure tests completed"
