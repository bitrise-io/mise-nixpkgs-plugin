#!/usr/bin/env bash
#MISE description="Run backend plugin tests - test plugin linking and basic functionality"
set -euo pipefail

TEST_TOOL="ruby"

cleanup_installs() {
    mise uninstall --all nixpkgs:${TEST_TOOL} 2>/dev/null || true
}

cleanup() {
    echo ""
    echo "=== Cleaning up test installations ==="
    cleanup_installs
    echo "✓ Cleanup completed"
}

trap cleanup EXIT

run_test() {
    local test_name="$1"
    local cmd="$2"

    echo -n "Testing ${test_name}..."
    if output=$(eval "$cmd" 2>&1); then
        echo -e " \033[32m✓\033[0m"
        return 0
    else
        echo -e " \033[31m✗ ${test_name} failed\033[0m"
        echo "Command: $cmd"
        echo "Output:"
        echo "$output"
        return 1
    fi
}

run_test_expect_failure() {
    local test_name="$1"
    local cmd="$2"

    echo "Testing ${test_name} (expect failure)..."
    if output=$(eval "$cmd" 2>&1); then
        echo "✗ ${test_name} should have failed but succeeded"
        return 1
    else
        echo "✓ ${test_name} failed as expected"
        return 0
    fi
}

mise plugin link --force nixpkgs .
mise cache clear

echo "=== Happy Path Tests ==="

run_test "version listing for ${TEST_TOOL}" \
    "mise ls-remote nixpkgs:${TEST_TOOL}" || exit 1

run_test "installation of ${TEST_TOOL}" \
    "mise install nixpkgs:${TEST_TOOL}@latest" || exit 1

run_test "tool execution for ${TEST_TOOL}" \
    "mise exec nixpkgs:${TEST_TOOL}@latest -- ${TEST_TOOL} --version" || exit 1

cleanup_installs

echo ""
echo "=== Specific Version Tests ==="

run_test "specific version installation" \
    "mise install nixpkgs:ruby@3.3.9" || exit 1

run_test "specific version execution" \
    "mise exec nixpkgs:ruby@3.3.9 -- ruby --version" || exit 1

cleanup_installs

echo ""
echo "=== Environment Variable Tests ==="

run_test "PATH is set correctly" \
    "mise exec nixpkgs:ruby@latest -- bash -c 'test -n \"\$PATH\"'" || exit 1

run_test "GEM_HOME is set for ruby" \
    "mise exec nixpkgs:ruby@latest -- bash -c 'test -n \"\$GEM_HOME\"'" || exit 1

echo ""
echo "=== Gem Install Tests ==="

run_test "ruby: gem install fastlane" \
    "mise exec nixpkgs:ruby@latest -- gem install fastlane" || exit 1

run_test "ruby: gem install cocoapods" \
    "mise exec nixpkgs:ruby@latest -- gem install cocoapods" || exit 1

# Needs libyaml from system libraries
run_test "ruby: gem install psych" \
    "mise exec nixpkgs:ruby@latest -- gem install psych" || exit 1

run_test "ruby: gem install psych: build from source" \
    "mise exec nixpkgs:ruby@latest -- gem install psych --platform ruby" || exit 1

cleanup_installs

echo ""
echo "=== Smoke Tests ==="

run_test "fastlane actions" \
    "mise exec nixpkgs:ruby@latest -- bash -c 'gem install fastlane && fastlane actions'" || exit 1

run_test "pod plugins" \
    "mise exec nixpkgs:ruby@latest -- bash -c 'gem install cocoapods && pod plugins --allow-root'" || exit 1

cleanup_installs

echo ""
echo "=== Error Handling Tests ==="

run_test_expect_failure "nonexistent tool errors gracefully" \
    "mise ls-remote nixpkgs:nonexistent-tool-xyz-12345" || exit 1

run_test_expect_failure "nonexistent version errors gracefully" \
    "mise install nixpkgs:${TEST_TOOL}@999.999.999" || exit 1

cleanup_installs

echo ""
echo "=== Version Listing Validation ==="

run_test "version list is not empty" \
    "mise ls-remote nixpkgs:${TEST_TOOL} | grep -c ''" || exit 1

echo ""
echo "✓ All integration tests passed"
